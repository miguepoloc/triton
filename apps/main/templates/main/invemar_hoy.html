{% load staticfiles %}
<!DOCTYPE html>
<html lang="es">

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Portal oceanográfico</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

    <link rel="stylesheet" href="{% static 'css/font-awesome.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/gmaps-sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap.css' %}">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://netdna.bootstrapcdn.com/font-awesome/4.0.3/css/font-awesome.css">

    <script src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>
    <script src="https://momentjs.com/downloads/moment.min.js"></script>


    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html,
        body,
        #map {
            height: 100%;
            font: 10pt "roboto", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            color: #AAA;
        }
    </style>
</head>

<body>
    <div class="container hidden-xs hidden-sm" style="margin-bottom: 6em;">
        <ul id="gn-menu" class="gn-menu-main">
            <div class="logo"></div>

            <div class="titulo2">
                <h1 class="titulo2-app">TRITON</h1>
                <h5>Observatorio de los Mares Tropicales de las Américas</h5>
            </div>

        </ul>

    </div>

    <nav class="hidden-lg hidden-md navbar navbar-default">
        <div class="container-fluid">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse"
                    data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <img alt="INVEMAR" src="http://www.invemar.org.co/Invemar3.0-theme/images/img/cd-logo.svg" alt=""
                    style="height:80px">
                <a class="navbar-brand" href="#"></a>
            </div>


            <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
                <ul class="nav navbar-nav">
                    <li><a href="/conectividad/"><b>Portal Oceanográfico</b></a></li>
                </ul>


            </div>
    </nav>
    <section>

        <div class="row">
            <div class="container-fluid">
                <div class="pull-right"><a class="btn btn-primary" href="/conectividad/"><i
                            class="glyphicon glyphicon-chevron-left"></i> Regresar al portal</a></div>
            </div>
        </div>
    </section>
    <section id="temperatura">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-4">
                    <div id="card" class="weater">
                        <div class="city-selected">
                            <article>
                                <div class="info">
                                    <div class="city"><span>Ciudad:</span> Santa Marta</div>
                                    <div id="time" class="night"></div>

                                    <div id="temp" class="temp"></div>

                                    <div class="city">

                                        <span id="wind"></span>
                                    </div>
                                </div>
                            </article>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div id="g-mareas" style="height: 300px;"></div>
                </div>
                <div class="col-md-2">
                    <h4 style="color:rgb(99, 94, 94);">Mareas</h4>
                    <table class="table">
                        <caption></caption>
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>Altura (m)</th>
                                <th>Tipo</th>
                            </tr>
                        </thead>
                        <tbody id="tbody">

                        </tbody>
                    </table>
                    <p><b>Fuente:</b> IDEAM (<a
                            href='http://www.ideam.gov.co/web/tiempo-y-clima/cartilla-pronostico-pleamares-bajamares-costa-atlantica-colombiana'>Sitio
                            oficial</a>)</p>
                </div>
            </div>
        </div>
    </section>


    <section id="g-temp">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6" id="containerTemp">

                </div>

                <div class="col-md-6" id="containerVientos">

                </div>
            </div>
        </div>
    </section>

    <section id="g-vientos">

    </section>


    <script type="text/javascript" src="{%  static 'js/jquery-2.1.1.js' %}"></script>
    <script type="text/javascript" src="{%  static 'js/jquery-sidebar.js' %}"></script>
    <script type="text/javascript" src="{%  static 'js/bootstrap.js' %}"></script>

    <script>
        function Meteogram(xml, container, t, h, v, p) {
            // Parallel arrays for the chart data, these are populated as the XML/JSON file
            // is loaded
            this.symbols = [];
            this.symbolNames = [];
            this.precipitations = [];
            this.windDirections = [];
            this.windDirectionNames = [];
            this.windSpeeds = [];
            this.windSpeedNames = [];
            this.temperatures = [];
            this.pressures = [];

            // Initialize
            this.xml = xml;
            this.container = container;
            this.t = t;
            this.h = h;
            this.v = v;
            this.p = p;
            // Run
            this.parseYrData();

        }

        /**
         * Callback function that is called from Highcharts on hovering each point and returns
         * HTML for the tooltip.
         */
        Meteogram.prototype.tooltipFormatter = function (tooltip) {

            // Create the header with reference to the time interval
            var index = tooltip.points[0].point.index,
                ret = '<small>' + Highcharts.dateFormat('%A, %b %e, %H:%M', tooltip.x) + '</small><br>';

            // Symbol text
            //ret += '<b>' + this.symbolNames[index] + '</b>';

            ret += '<table>';
            var v = this.v;
            // Add all series
            Highcharts.each(tooltip.points, function (point) {
                var series = point.series;
                ret += '<tr><td><span style="color:' + series.color + '">\u25CF</span> ' + series.name +
                    ': </td><td style="white-space:nowrap">' + Highcharts.pick(point.point.value, point.y)
                    .toFixed(1) +
                    series.options.tooltip.valueSuffix + '</td></tr>';
            });

            // Add wind
            /*
    ret += '<tr><td style="vertical-align: top">\u25CF Vientos</td><td style="white-space:nowrap">Dirección: ' + this.windDirections[index].toFixed(1) +
        '<br>Velocidad: ' +
        Highcharts.numberFormat(this.windSpeeds[index], 1) + ' m/s</td></tr>';
    */
            // Close
            ret += '</table>';


            return ret;
        };

        /**
         * Draw the weather symbols on top of the temperature series. The symbols are sprites of a single
         * file, defined in the getSymbolSprites function above.
         */
        Meteogram.prototype.drawWeatherSymbols = function (chart) {
            var meteogram = this;

        };

        /**
         * Create wind speed symbols for the Beaufort wind scale. The symbols are rotated
         * around the zero centerpoint.
         */
        Meteogram.prototype.windArrow = function (valor) {
            var level,
                path;

            // The stem and the arrow head
            path = [
                'M', 0, 7, // base of arrow
                'L', -1.5, 7,
                0, 10,
                1.5, 7,
                0, 7,
                0, -10 // top
            ];
            if (valor < 1) {
                level = 0;
            } else if (valor < 2) {
                level = 1;
            } else if (valor < 3) {
                level = 2;
            } else if (valor < 5) {
                level = 3;
            } else if (valor < 8) {
                level = 4;
            } else if (valor < 11) {
                level = 5;
            } else if (valor < 14) {
                level = 6;
            } else if (valor < 17) {
                level = 7;
            } else if (valor < 21) {
                level = 8;
            } else if (valor < 24) {
                level = 9;
            } else if (valor < 28) {
                level = 10;
            } else if (valor < 32) {
                level = 11;
            } else {
                level = 12;
            }

            if (level === 0) {
                path = [];
            }

            if (level === 2) {
                path.push('M', 0, -8, 'L', 4, -8); // short line
            } else if (level >= 3) {
                path.push(0, -10, 7, -10); // long line
            }

            if (level === 4) {
                path.push('M', 0, -7, 'L', 4, -7);
            } else if (level >= 5) {
                path.push('M', 0, -7, 'L', 7, -7);
            }

            if (level === 5) {
                path.push('M', 0, -4, 'L', 4, -4);
            } else if (level >= 6) {
                path.push('M', 0, -4, 'L', 7, -4);
            }

            if (level === 7) {
                path.push('M', 0, -1, 'L', 4, -1);
            } else if (level >= 8) {
                path.push('M', 0, -1, 'L', 7, -1);
            }

            return path;
        };

        /**
         * Draw the wind arrows. Each arrow path is generated by the windArrow function above.
         */
        Meteogram.prototype.drawWindArrows = function (chart) {
            var meteogram = this;

            $.each(chart.series[0].data, function (i, point) {
                var arrow, x, y;

                if (meteogram.resolution > 36e5 || i % 2 === 0) {

                    // Draw the wind arrows
                    x = point.plotX + chart.plotLeft + 7;
                    y = 255;
                    if (meteogram.windSpeedNames[i] === 'Calm') {
                        arrow = chart.renderer.circle(x, y, 10).attr({
                            fill: 'none'
                        });
                    } else {
                        arrow = chart.renderer.path(
                            meteogram.windArrow(meteogram.windSpeeds[i].y)
                        ).attr({
                            rotation: parseInt(meteogram.windDirections[i], 10),
                            translateX: x, // rotation center
                            translateY: y // rotation center
                        });
                    }
                    arrow.attr({
                            stroke: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                            'stroke-width': 1.5,
                            zIndex: 5
                        })
                        .add();

                }
            });
        };

        /**
         * Draw blocks around wind arrows, below the plot area
         */
        Meteogram.prototype.drawBlocksForWindArrows = function (chart) {
            var xAxis = chart.xAxis[0],
                x,
                pos,
                max,
                isLong,
                isLast,
                i;

            for (pos = xAxis.min, max = xAxis.max, i = 0; pos <= max + 36e5; pos += 36e5, i += 1) {

                // Get the X position
                isLast = pos === max + 36e5;
                x = Math.round(xAxis.toPixels(pos)) + (isLast ? 0.5 : -0.5);

                // Draw the vertical dividers and ticks
                if (this.resolution > 36e5) {
                    isLong = pos % this.resolution === 0;
                } else {
                    isLong = i % 2 === 0;
                }
                chart.renderer.path(['M', x, chart.plotTop + chart.plotHeight + (isLong ? 0 : 28),
                        'L', x, chart.plotTop + chart.plotHeight + 32, 'Z'
                    ])
                    .attr({
                        'stroke': chart.options.chart.plotBorderColor,
                        'stroke-width': 1
                    })
                    .add();
            }
        };

        /**
         * Get the title based on the XML data
         */
        Meteogram.prototype.getTitle = function () {
            if (this.t) {
                return "Historial Temperatura/Humedad";
            } else {
                return "Historial Vientos/Presión atmosférica";
            }

        };

        /**
         * Build and return the Highcharts options structure
         */
        Meteogram.prototype.getChartOptions = function () {
            var meteogram = this;
            var serieSel = [];
            var ySel = [];
            if (this.t) {
                serieSel.push({
                    name: 'Temperatura',
                    data: this.temperatures,
                    type: 'spline',
                    marker: {
                        enabled: false,
                        states: {
                            hover: {
                                enabled: true
                            }
                        }
                    },

                    tooltip: {
                        valueSuffix: '°C'
                    },
                    zIndex: 1,
                    color: '#FF3333',
                    negativeColor: '#48AFE8'
                });
                ySel.push({ // temperature axis
                    title: {
                        text: null
                    },
                    labels: {
                        format: '{value}°C',
                        style: {
                            fontSize: '10px'
                        },
                        x: -3
                    },
                    floor: 23,
                    ceiling: 35,
                    plotLines: [{ // zero plane
                        value: 0,
                        color: '#BBBBBB',
                        width: 1,
                        zIndex: 2
                    }],
                    // Custom positioner to provide even temperature ticks from top down
                    tickPositioner: function () {
                        var max = Math.ceil(this.max) + 1,
                            pos = max - 12, // start
                            ret;

                        if (pos < this.min) {
                            ret = [];
                            while (pos <= max) {
                                ret.push(pos += 1);
                            }
                        } // else return undefined and go auto

                        return ret;

                    },
                    maxPadding: 0.3,
                    tickInterval: 1,
                    gridLineColor: (Highcharts.theme && Highcharts.theme.background2) || '#F0F0F0'

                });
            }

            if (this.v) {
                serieSel.push({
                    name: 'vientos',
                    data: this.windSpeeds,
                    type: 'spline',
                    marker: {
                        enabled: false,
                        states: {
                            hover: {
                                enabled: true
                            }
                        }
                    },
                    tooltip: {
                        valueSuffix: 'm/s'
                    },
                    zIndex: 1,
                    color: '#FF3333',
                    negativeColor: '#48AFE8'
                });
                ySel.push({ // temperature axis
                    title: {
                        text: null
                    },
                    labels: {
                        format: '{value}m/s',
                        style: {
                            fontSize: '10px'
                        },
                        x: -3
                    },
                    plotLines: [{ // zero plane
                        value: 0,
                        color: '#BBBBBB',
                        width: 1,
                        zIndex: 2
                    }],
                    // Custom positioner to provide even temperature ticks from top down
                    tickPositioner: function () {
                        var max = Math.ceil(this.max) + 1,
                            pos = max - 12, // start
                            ret;

                        if (pos < this.min) {
                            ret = [];
                            while (pos <= max) {
                                ret.push(pos += 1);
                            }
                        } // else return undefined and go auto

                        return ret;

                    },
                    maxPadding: 0.3,
                    tickInterval: 1,
                    gridLineColor: (Highcharts.theme && Highcharts.theme.background2) || '#F0F0F0'

                });
            }
            if (this.h) {
                serieSel.push({
                    name: 'Humedad relativa',
                    data: this.precipitations,
                    type: 'spline',
                    color: '#68CFE8',
                    yAxis: 1,
                    groupPadding: 0,
                    pointPadding: 0,
                    borderWidth: 0,
                    shadow: false,
                    tooltip: {
                        valueSuffix: '%'
                    }
                });
                ySel.push({
                    allowDecimals: true,
                    title: { // Title on top of axis
                        text: '%',
                        offset: 0,
                        align: 'high',
                        rotation: 0,
                        style: {
                            fontSize: '10px',
                            color: '#68CFE8'
                        },
                        textAlign: 'left',
                        x: 3
                    },
                    floor: 0,
                    ceiling: 80,
                    labels: {
                        style: {
                            fontSize: '8px',
                            color: '#68CFE8'
                        },
                        y: 2,
                        x: 3
                    },
                    gridLineWidth: 0,
                    tickLength: 0,
                    opposite: true,
                    showLastLabel: false

                });
            }
            if (this.p) {
                serieSel.push({
                    name: 'presion del aire',
                    data: this.pressures,
                    type: 'spline',
                    color: Highcharts.getOptions().colors[2],
                    yAxis: 1,
                    groupPadding: 0,
                    pointPadding: 0,
                    borderWidth: 0,
                    shadow: false,
                    tooltip: {
                        valueSuffix: ' mbares'
                    }
                });
                ySel.push({ // Air pressure
                    allowDecimals: true,

                    title: { // Title on top of axis
                        text: 'mbares',
                        offset: 0,

                        align: 'high',
                        rotation: 0,
                        style: {
                            fontSize: '10px',
                            color: Highcharts.getOptions().colors[2]
                        },
                        textAlign: 'left',
                        x: 3
                    },
                    floor: 1005,
                    ceiling: 1013,
                    labels: {
                        style: {
                            fontSize: '8px',
                            color: Highcharts.getOptions().colors[2]
                        }
                    },
                    gridLineWidth: 0,
                    opposite: true,
                    showLastLabel: false
                });
            }
            return {
                chart: {
                    renderTo: this.container,
                    marginBottom: 70,
                    marginRight: 40,
                    marginTop: 50,
                    plotBorderWidth: 1,
                    /* width: 800,*/
                    height: 310
                },

                title: {
                    text: this.getTitle(),
                    align: 'left'
                },

                credits: {
                    text: 'INVEMAR',
                    href: "www.invemar.org.co",
                    position: {
                        x: -40
                    }
                },

                tooltip: {
                    shared: true,
                    useHTML: true,
                    formatter: function () {
                        return meteogram.tooltipFormatter(this);
                    }
                },

                xAxis: [{ // Bottom X axis
                    type: 'datetime',
                    tickInterval: 2 * 36e5, // two hours
                    minorTickInterval: 36e5, // one hour
                    tickLength: 0,
                    gridLineWidth: 1,
                    gridLineColor: (Highcharts.theme && Highcharts.theme.background2) || '#F0F0F0',
                    startOnTick: false,
                    endOnTick: false,
                    minPadding: 0,
                    maxPadding: 0,
                    offset: 30,
                    showLastLabel: true,
                    labels: {
                        format: '{value:%H}'
                    }
                }, { // Top X axis
                    linkedTo: 0,
                    type: 'datetime',
                    tickInterval: 24 * 3600 * 1000,
                    labels: {
                        format: '{value:<span style="font-size: 12px; font-weight: bold">%a</span> %b %e}',
                        align: 'left',
                        x: 3,
                        y: -5
                    },
                    opposite: true,
                    tickLength: 20,
                    gridLineWidth: 1
                }],

                yAxis: ySel,

                legend: {
                    enabled: false
                },

                plotOptions: {
                    series: {
                        pointPlacement: 'between'
                    }
                },


                series: serieSel
            };
        };

        Meteogram.prototype.onChartLoad = function (chart) {

            this.drawWeatherSymbols(chart);
            if (this.v) {
                this.drawWindArrows(chart);
                this.drawBlocksForWindArrows(chart);
            }
        };

        Meteogram.prototype.createChart = function () {
            var meteogram = this;
            Highcharts.setOptions({
                global: {
                    useUTC: true,
                    timezoneOffset: -5
                },
                lang: {
                    loading: 'Cargando...',
                    months: ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio', 'Julio', 'Agosto',
                        'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
                    ],
                    weekdays: ['Domingo', 'Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'],
                    shortMonths: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct',
                        'Nov', 'Dic'
                    ],
                    exportButtonTitle: "Exportar",
                    printButtonTitle: "Importar",
                    rangeSelectorFrom: "Desde",
                    rangeSelectorTo: "Hasta",
                    rangeSelectorZoom: "Periodo",
                    downloadPNG: 'Descargar imagen PNG',
                    downloadJPEG: 'Descargar imagen JPEG',
                    downloadPDF: 'Descargar imagen PDF',
                    downloadSVG: 'Descargar imagen SVG',
                    printChart: 'Imprimir',
                    resetZoom: 'Reiniciar zoom',
                    resetZoomTitle: 'Reiniciar zoom',
                    thousandsSep: ",",
                    decimalPoint: '.'
                }
            });


            this.chart = new Highcharts.Chart(this.getChartOptions(), function (chart) {
                meteogram.onChartLoad(chart);

            });

        };

        Meteogram.prototype.error = function () {
            $('#loading').html('<i class="fa fa-frown-o"></i> Failed loading data, please try again later');
        };

        Meteogram.prototype.parseYrData = function () {

            var meteogram = this,
                xml = this.xml,
                pointStart;
            $.each(xml, function (i, dato) {
                var fecha = dato.FECHA - 18000000;

                meteogram.temperatures.push({
                    x: fecha,
                    y: dato.TEMPERATURA
                });

                meteogram.windDirections.push(
                    dato.DIRECCION_VIENTO
                );

                meteogram.windSpeeds.push({
                    x: fecha,
                    y: dato.VELOCIDAD_VIENTO
                });

                meteogram.precipitations.push({
                    x: fecha,
                    y: dato.HUMEDAD_RELATIVA
                });

                if (dato.PRESION != null) {
                    meteogram.pressures.push({
                        x: fecha,
                        y: dato.PRESION * 1000
                    });
                }

            });

            this.createChart();
        };
        $.ajax({
            dataType: 'json',
            url: '/conectividad/consultar-datos',
            success: function (xml) {
                console.log(xml);
                window.meteogram = new Meteogram(xml, 'containerTemp', true, true, false, false);
                window.meteogram = new Meteogram(xml, 'containerVientos', false, false, true, true);
                var fecha = new Date(xml[0].FECHA);
                $("#time").html(fecha.getFullYear() + "/" + (fecha.getMonth() + 1) + "/" + fecha.getDate() +
                    " " + fecha.getHours() + ":" + fecha.getMinutes());
                $("#temp").html(xml[0].TEMPERATURA.toFixed(1) + "°C");
                $("#wind").html("Velocidad de viento: " + xml[xml.length - 1].VELOCIDAD_VIENTO.toFixed(1) +
                    " m/s");

            },
            error: Meteogram.prototype.error
        });
        $.ajax({
            dataType: 'json',
            url: '/datos',
            success: function (xml) {
                console.log(xml);
                var htmlStr = "";
                for (var i = 0; i < xml.length; i++) {


                    htmlStr += '<tr> <td >' + xml[i].hora + '</td>';
                    htmlStr += '<td>' + xml[i].altura + '</td>' +
                        '<td>' + xml[i].mareaTexto + '</td> </tr>';
                }
                $("#tbody").html(htmlStr);
            },
            error: Meteogram.prototype.error
        });
        $.ajax({
            dataType: 'json',
            url: '/datos-horas',
            success: function (xml) {
                var dataMareas = [];
                var horActual = [];
                var d = new Date();
                for (var i = 0; i < xml.length; i++) {
                    dataMareas.push(xml[i].altura);
                    if (d.getMinutes() - 5 < xml[i].minuto && d.getMinutes() + 5 > xml[i].minuto && d
                        .getHours() == xml[i].hora) {
                        horActual.push(xml[i].altura);
                    } else {
                        horActual.push(null);
                    }
                }
                Highcharts.chart('g-mareas', {
                    chart: {
                        type: 'area'
                    },
                    title: {
                        text: 'Nivel del mar'
                    },
                    xAxis: {
                        type: 'datetime'
                        //categories: ['Apples', 'Oranges', 'Pears', 'Grapes', 'Bananas']
                    },
                    yAxis: [{ // precipitation axis
                        title: {
                            text: 'altura (m)'
                        }

                    }],
                    credits: {
                        enabled: false
                    },
                    series: [{

                            name: 'Marea',
                            data: dataMareas,
                            pointStart: Date.UTC(d.getYear(), xml[0].mes - 1, xml[0].dia),
                            pointInterval: 60000
                        },
                        {
                            name: 'Valor actual',
                            data: horActual,
                            pointStart: Date.UTC(d.getYear(), xml[0].mes - 1, xml[0].dia),
                            pointInterval: 60000

                        }
                    ]
                });

            },
            error: Meteogram.prototype.error
        });
    </script>
</body>
</html>